<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>XWR Space</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="A VR/AR content space for editing and viewing" />
	<meta name="keywords" content="virtual reality, augmented reality, mixed reality, content web editor, webized network, webized device" />
	<meta name="author" content="wrl.onl" />

	<!--
	//////////////////////////////////////////////////////

	DEVELOPED by Yongjae Lee at Webizing Research Laboratory.

	website:		http://www.wrl.onl/
	Email:			yongjae.lee@wrl.onl

	//////////////////////////////////////////////////////
	 -->

	<!-- Facebook and Twitter integration -->
	<meta property="og:title" content=""/>
	<meta property="og:image" content=""/>
	<meta property="og:url" content=""/>
	<meta property="og:site_name" content=""/>
	<meta property="og:description" content=""/>
	<meta name="twitter:title" content="" />
	<meta name="twitter:image" content="" />
	<meta name="twitter:url" content="" />
	<meta name="twitter:card" content="" />

	<link rel="icon" href="https://getbootstrap.com/favicon.ico">

	<!-- Bootstrap core CSS -->
	<link href="/libs/bootstrap/bootstrap.min.css" rel="stylesheet">

	<!-- Font awesome CSS -->
	<link href="/libs/font-awesome/css/font-awesome.min.css" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link href="/stylesheets/style.css" rel="stylesheet">
</head>

<body>

	<!-- Header -->
	<%- include('template/header'); -%>

	<main role="main">

		<!-- Page Header -->
		<div class="container">
			<h1 class="pl-4 mt-5 mb-3">My Devices</h1>
			<hr class="wxr-sm-divider">
		</div>


		<div class="container">
			<div class="row m-5">
				<table id="device_list" class="table table-hover wxr-no-top-border">
					<thead>
					<tr>
						<th scope="col-1">#</th>
						<th scope="col">Name</th>
						<th scope="col">Device</th>
						<th scope="col">DeviceType</th>
						<th scope="col">ConnectionType</th>
						<th scope="col">Status</th>
						<th scope="col">EventStreamEnable</th>
						<th scope="col-1">Delete</th>
					</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>

	</main>

	<!-- Footer -->
	<%- include('template/footer'); -%>


	<!-- jQuery -->
	<script src="/libs/jquery/jquery.min.js"></script>
	<!-- autosize -->
	<script src="/libs/jquery/jquery.autosize.js"></script>
	<!-- Waypoints -->
	<script src="/libs/jquery/jquery.waypoints.min.js"></script>
	<!-- jQuery UI -->
	<script src="/libs/jquery/ui/effect.js"></script>
	<!-- Bootstrap -->
	<script src="/libs/bootstrap/bootstrap.min.js"></script>
	<!-- Socket.io -->
	<script src="/libs/socket.io/socket.io.js"></script>
	<!-- Webizing Device Configuration Manager -->
	<script src="/javascripts/webizingDeviceConfigurationManager.js"></script>

	<script>

		function refreshDeviceList(profiles) {
			let $deviceList = $('#device_list');

			let $newTbody = $('<tbody></tbody>');
			profiles.forEach( (e, i) => {
				const id = !e.id || e.id === 'device no id' ? '' : e.id;
				let $row = $(`<tr id="${id}" class="${id ? '' : 'table-warning'}">
								<th scope="row">${i+1}</th>
								<td role="name"><input class="form-control wxr-form-control" type="text" value="${e.name}" ${id ? '' : 'readonly'}></td>
								<td role="device">${e.device}</td>
								<td role="deviceType">${e.deviceType}</td>
								<td role="connectionType"><input class="form-control wxr-form-control" type="text" value="${e.connectionType}" ${id ? '' : 'readonly'}></td>
								<td role="status"><input class="form-control wxr-form-control" type="text" value="${e.status}" ${id ? '' : 'readonly'}></td>
								<td role="eventStreamEnable"><input class="form-control wxr-form-control" type="text" value="${e.eventStreamEnable}" ${id ? '' : 'readonly'}></td>
								<td><button class="btn btn-primary btn-sm wxr-button wxr-bg-blue" onclick="saveDeviceProfile(this)">Delete</button></td>
							</tr>`);
				$newTbody.append($row);
			});

			$('tbody', $deviceList).remove();
			$deviceList.append($newTbody);
		}
		webizingDeviceConfigurationManager.addUpdateListener(refreshDeviceList);


		// this function should be moved to WebizingDeviceConfigurationManager.js
		function saveDeviceProfile(btn) {
			const $profileRoot = $(btn.parentNode.parentNode);	// getting parent <tr> node.
		  	const deviceId = $profileRoot.attr('id');
			const profile = {
				name: $('[role="name"] input', $profileRoot).val(),
				device: $('[role="device"]', $profileRoot).text(),
				deviceType: $('[role="deviceType"]', $profileRoot).text(),
				connectionType: $('[role="connectionType"] input', $profileRoot).val(),
				status: $('[role="status"] input', $profileRoot).val(),
				eventStreamEnable: $('[role="eventStreamEnable"] input', $profileRoot).val()
			};
		  	if (deviceId) {
				webizingDeviceConfigurationManager.updateProfile(deviceId, profile);
				// webizingDeviceConfigurationManager.updateProfile(deviceId, profile, data => console.log('Update device profile is done: ', data));
			} else {
				webizingDeviceConfigurationManager.createProfile(profile);
				// webizingDeviceConfigurationManager.createProfile(profile, data => console.log('Create device profile is done: ', data));
			}
		}

	</script>

</body>

</html>